name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Get version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Install production dependencies
        run: |
          composer install \
            --no-dev \
            --optimize-autoloader \
            --no-interaction \
            --quiet

      - name: Build plugin
        run: |
          mkdir -p build/bavarian-rank-engine
          rsync -a \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.gitignore' \
            --exclude='.claude/' \
            --exclude='node_modules/' \
            --exclude='vendor/phpunit/' \
            --exclude='vendor/nikic/' \
            --exclude='vendor/sebastian/' \
            --exclude='vendor/phar-io/' \
            --exclude='vendor/theseer/' \
            --exclude='vendor/myclabs/' \
            --exclude='tests/' \
            --exclude='docs/' \
            --exclude='bin/' \
            --exclude='README.md' \
            --exclude='composer.phar' \
            --exclude='phpunit.xml' \
            --exclude='.phpunit.result.cache' \
            --exclude='*.log' \
            . build/bavarian-rank-engine/
          rm -rf build/bavarian-rank-engine/vendor/bin

      - name: Create ZIP
        run: |
          cd build
          zip -r ../bavarian-rank-engine.zip bavarian-rank-engine/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Bavarian Rank Engine v${{ steps.version.outputs.version }}"
          files: bavarian-rank-engine.zip
          generate_release_notes: true
